<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Custom Led Controller | julian.patterson</title>
<meta name="keywords" content="Rust, IoT, Restful-API, Docker, Docker-Compose, Actix_web">
<meta name="description" content="How laziness turned into full scale home-automation">
<meta name="author" content="Julian Patterson">
<link rel="canonical" href="http://localhost:1313/projects/posts/custom-led-controller/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/projects/posts/custom-led-controller/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="julian.patterson (Alt + H)">julian.patterson</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/blog" title="blog">
                    <span>blog</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/projects" title="projects">
                    <span>projects</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/edu" title="education">
                    <span>education</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/experience" title="experience">
                    <span>experience</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Custom Led Controller
    </h1>
    <div class="post-meta"><span title='2024-12-07 00:00:00 +0000 UTC'>December 7, 2024</span>&nbsp;·&nbsp;Julian Patterson

</div>
  </header> 
  <div class="post-content"><h2 id="background">Background<a hidden class="anchor" aria-hidden="true" href="#background">#</a></h2>
<p>I first started messing around in IoT when I was 16 years old.
At the time, I was really interested in being able to control
my bedrooms lights from my phone. Coincidentally, I was gifted a LED strip (WS_281x)
and a RPi Zero shortly afterwards. I used a python library in order to control the strip and in the end of the day. I had
a working solution to my problem, SSH into the Pi, run the python script to change colors, and then close the
connection. It worked great (not)!!</p>
<h2 id="first-iteration----python-api">First Iteration &ndash; Python API<a hidden class="anchor" aria-hidden="true" href="#first-iteration----python-api">#</a></h2>
<p>My first iteration after this was to create a API, and be able to access it from a website. For example,
I would go to <code>http://ip_address_of_pi/off</code> and that would trigger the function. I found out that I could also use Apple Shortcuts
to send JSON requests to different APIs, so essential I would have a shortcut for every function I wanted sending different
lighting commands. The request would look something like this:</p>
<pre tabindex="0"><code>{
    r: 120
    g: 120 
    b: 120
}
</code></pre><p>I would send similar JSON to different endpoints for different functions (brightness, HSV, RGB, off, on, animations, etc. ).
This was the beginning of my rabbit hole in IoT / Home automation, you can check out my blog posts for more about that.</p>
<h2 id="second-iteration----rust">Second Iteration &ndash; Rust<a hidden class="anchor" aria-hidden="true" href="#second-iteration----rust">#</a></h2>
<p>My second iteration was to redesign this whole project in Rust. Why ? Because why not. It offered me an opportunity to
learn a super popular (and praised) language. My original docker image had also started giving me a lot of problems, since
the RPi Zero is 32-bit ARM and the dependencies were getting out of hand. I also was able to find a proper library to control my WS_281x lights, and I was off.</p>
<p>First, I created <code>main.rs</code> which is responsible for starting the webserver. Here, I define the endpoints, initialize the strip,
and define JSON data structures. I created, on / off, brightness, HSV, light temperature, and animation endpoints to support
all the functionality I wanted. I used Actix_web library to manage my server and endpoints.
Each endpoint just wraps the <code>strip.rs</code> function that actually handles the strip &amp; color logic.
Here&rsquo;s an example of one of my endpoints:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[post(</span><span style="color:#e6db74">&#34;/hsv&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">strip_set_hsv</span>(<span style="color:#66d9ef">mut</span> payload: <span style="color:#a6e22e">web</span>::Payload) -&gt; Result<span style="color:#f92672">&lt;</span>HttpResponse, Error<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> body <span style="color:#f92672">=</span> web::BytesMut::new();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">let</span> Some(chunk) <span style="color:#f92672">=</span> payload.next().<span style="color:#66d9ef">await</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> chunk <span style="color:#f92672">=</span> chunk<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (body.len() <span style="color:#f92672">+</span> chunk.len()) <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">MAX_SIZE</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Err(error::ErrorBadRequest(<span style="color:#e6db74">&#34;overflow&#34;</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        body.extend_from_slice(<span style="color:#f92672">&amp;</span>chunk);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> hsv <span style="color:#f92672">=</span> serde_json::from_slice::<span style="color:#f92672">&lt;</span>HsvDto<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span>body)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>    strip::strip_set_hsv(hsv.h, hsv.s, hsv.v);
</span></span><span style="display:flex;"><span>    Ok(HttpResponse::Ok().body(format!(<span style="color:#e6db74">&#34;Setting HSV: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, hsv.h, hsv.s, hsv.v)))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Second, I created <code>strip.rs</code> which implemented the logic of actually displaying the colors on the strip. I started off with the static functions,
setting colors, setting brightness, and temperature where all pretty straight forward. Where things got interesting was when I started creating animations (dynamic functions).
This brought in multi-threading, where I had to be sure that there is no two animations running at once. Multi-threading was also important to since,
these animations needed to run indefinite, or until a controller turned them off. This worked out with with Rust&rsquo;s <code>AtomicBool</code> which
is basically just a conditional-variable used to indicate when an animation is running. Luckily everything worked out in the end. Here&rsquo;s an example of one of my
animations using multi-threading:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">rainbow</span>() {
</span></span><span style="display:flex;"><span>    thread::spawn(<span style="color:#66d9ef">move</span> <span style="color:#f92672">||</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">ANIMATION_RUNNING</span>.load(Ordering::SeqCst) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> controller <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">STRIP</span>.as_ref().unwrap().lock().unwrap()
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> led_count <span style="color:#f92672">=</span> controller.leds_mut(<span style="color:#ae81ff">0</span>).len();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> color <span style="color:#f92672">=</span> [<span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>]; <span style="color:#75715e">// Start with Red
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">loop</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Transition logic
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> color[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">255</span> <span style="color:#f92672">&amp;&amp;</span> color[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">255</span> <span style="color:#f92672">&amp;&amp;</span> color[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> { <span style="color:#75715e">// Red to Yellow
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    color[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> color[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> color[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">255</span> { <span style="color:#75715e">// Yellow to Green
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    color[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> color[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">255</span> <span style="color:#f92672">&amp;&amp;</span> color[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">255</span> { <span style="color:#75715e">// Green to Cyan
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    color[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> color[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">255</span> <span style="color:#f92672">&amp;&amp;</span> color[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> { <span style="color:#75715e">// Cyan to Blue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    color[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> color[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">255</span> <span style="color:#f92672">&amp;&amp;</span> color[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">255</span> { <span style="color:#75715e">// Blue to Purple
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    color[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> color[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">255</span> <span style="color:#f92672">&amp;&amp;</span> color[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> { <span style="color:#75715e">// Purple to Red
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    color[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Apply the current color to all LEDs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>led_count {
</span></span><span style="display:flex;"><span>                    controller.leds_mut(<span style="color:#ae81ff">0</span>)[i] <span style="color:#f92672">=</span> color;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">ANIMATION_RUNNING</span>.load(Ordering::SeqCst) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>                controller.render().unwrap();
</span></span><span style="display:flex;"><span>                std::thread::sleep(std::time::Duration::from_millis(<span style="color:#ae81ff">50</span>));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Third, I wanted to create a Docker image to easily deploy on my RPi. I was developing on my laptop and
writing code through SSH and on a RPi was too buggy, so my cycle would be to write, test, push to git,
and pull on RPi to test with their hardware. The Dockerfile helped me deploy faster, by using docker-compose
commands and also helped normalize the development environment between the RPi and my laptop.</p>
<p>Lastly, I created <code>/strip/colors.rs</code> which contains the logic for converting color values from different endpoints, basically,
just code to work with some Home Assistant UI.</p>
<h2 id="source-code">Source Code<a hidden class="anchor" aria-hidden="true" href="#source-code">#</a></h2>
<p>Feel free to look at the source code of the project <a href="https://github.com/patterson-project/custom-led-controller">here</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/rust/">Rust</a></li>
      <li><a href="http://localhost:1313/tags/iot/">IoT</a></li>
      <li><a href="http://localhost:1313/tags/restful-api/">Restful-API</a></li>
      <li><a href="http://localhost:1313/tags/docker/">Docker</a></li>
      <li><a href="http://localhost:1313/tags/docker-compose/">Docker-Compose</a></li>
      <li><a href="http://localhost:1313/tags/actix_web/">Actix_web</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">julian.patterson</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
